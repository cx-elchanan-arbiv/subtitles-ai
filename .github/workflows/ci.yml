name: CI

# Run on push to main and all Pull Requests to main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: ðŸ“¦ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        
    - name: ðŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install -r requirements-test.txt
        pip install -e backend/
        
    - name: ðŸ§ª Run Backend Tests with Coverage
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        FLASK_TESTING: "1"
        DISABLE_RATE_LIMIT: "1"
        TESTING: "true"
      run: |
        # Run only unit tests in CI (integration tests require Docker/services)
        python -m pytest backend/tests/unit/ -v --tb=short -m unit --cov=backend --cov-report=xml --cov-report=term
        
    - name: ðŸ“ˆ Upload Coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage.xml
        flags: backend
        name: backend-coverage

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ./frontend/package-lock.json
        
    - name: ðŸ“¦ Install Dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: ðŸ§ª Run Frontend Tests
      working-directory: ./frontend
      run: npm test -- --coverage --watchAll=false --verbose
      
    - name: ðŸ“ˆ Upload Coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  lint-and-format:
    name: Code Quality Check
    runs-on: ubuntu-latest
    if: false  # Skip code quality checks for now
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: ðŸ“¦ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ./frontend/package-lock.json
        
    - name: ðŸ” Check Python Code Style (Backend)
      env:
        FLASK_TESTING: "1"
        DISABLE_RATE_LIMIT: "1"
        TESTING: "true"
      run: |
        pip install flake8 black isort ruff
        pip install -r backend/requirements.txt
        pip install -e backend/
        # Check formatting
        black --check backend/
        # Check imports  
        isort --check-only backend/
        # Check linting with ruff (modern replacement)
        ruff check backend/
        
    - name: ðŸ” Check TypeScript Code Style (Frontend)
      working-directory: ./frontend
      run: |
        npm ci
        # Check TypeScript compilation
        npm run build
        # Check linting (if you have ESLint configured)
        # npm run lint

  security-check:
    name: Security Scan
    runs-on: ubuntu-latest
    if: false  # Skip security scans for now
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: ðŸ”§ Create Virtual Environment
      run: |
        python -m venv .venv
        source .venv/bin/activate
        python -m pip install -U pip setuptools wheel
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        source .venv/bin/activate
        pip install -r backend/requirements.txt
        pip install pip-audit bandit
        
    - name: ðŸ”’ Security Audit (Project Dependencies Only)
      run: |
        source .venv/bin/activate
        pip-audit -r backend/requirements.txt --desc
        
    - name: ðŸ”’ Code Security Analysis
      run: |
        source .venv/bin/activate
        bandit -r backend/ -x backend/venv/,backend/__pycache__/
        
    - name: ðŸ”’ Run Node.js Security Audit
      working-directory: ./frontend
      run: |
        npm audit --audit-level high



  # Job ×©×ž×¦×¨×£ ××ª ×›×œ ×”×ª×•×¦××•×ª - × ×“×¨×© ×œ×‘×“×™×§×ª ×”×’× ×ª ×”×¢× ×£
  all-tests-passed:
    name: âœ… All Tests Passed
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - name: âœ… All Checks Passed
      run: |
        echo "ðŸŽ‰ ×›×œ ×”×˜×¡×˜×™× ×¢×‘×¨×• ×‘×”×¦×œ×—×”!"
        echo "ðŸš€ ×”×§×•×“ ×ž×•×›×Ÿ ×œ×ž×¢×¨×’ ×œ-main"
        
    - name: ðŸ“Š Summary
      run: |
        echo "### ðŸ“‹ Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Backend Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Frontend Tests: Passed" >> $GITHUB_STEP_SUMMARY  

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Ready for merge to main!**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â„¹ï¸ *Integration and E2E tests can be run manually via GitHub Actions*" >> $GITHUB_STEP_SUMMARY
