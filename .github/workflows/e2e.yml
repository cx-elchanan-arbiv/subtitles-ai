name: E2E

# Run E2E tests only manually (they're slow, resource intensive, and depend on external services)
on:
  workflow_dispatch: # Allow manual trigger only
    inputs:
      test_type:
        description: 'Type of E2E tests to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - online_video
        - file_upload

jobs:
  e2e-tests:
    name: ðŸŒ End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30  # E2E tests can take time
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v6
      
    - name: ðŸ Setup Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: ðŸ³ Setup Docker
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ“¦ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg curl jq
        
    - name: ðŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install -r requirements-test.txt
        pip install -e backend/
        
    - name: ðŸ³ Start Services
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        # Create .env file for docker compose
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
        echo "FLASK_ENV=production" >> .env
        echo "DEBUG=false" >> .env
        
        # Start all services
        docker compose up -d --build
        
        # Wait for services to be ready
        echo "â³ Waiting for services to start..."
        sleep 30
        
        # Verify services are healthy
        curl --retry 10 --retry-delay 5 http://localhost:8081/health
        curl --retry 5 --retry-delay 3 http://localhost
        
    - name: ðŸ§ª Run E2E Tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        # Activate virtual environment
        source venv/bin/activate || python -m venv venv && source venv/bin/activate
        
        if [ "${{ github.event.inputs.test_type }}" = "online_video" ]; then
          echo "ðŸŽ¯ Running Online Video E2E tests only..."
          python test_online_video.py --verbose
        elif [ "${{ github.event.inputs.test_type }}" = "file_upload" ]; then
          echo "ðŸ“ Running File Upload E2E tests only..."
          pytest backend/tests/e2e/ -k "file_upload" -v --tb=short
        else
          echo "ðŸŒ Running all E2E tests..."
          pytest backend/tests/e2e/ -v --tb=short -m e2e
        fi
        
    - name: ðŸ“‹ Collect Test Artifacts
      if: always()
      run: |
        # Create artifacts directory
        mkdir -p test-artifacts
        
        # Copy any generated files
        if [ -d "backend/downloads" ]; then
          cp -r backend/downloads test-artifacts/downloads || true
        fi
        
        # Get recent logs
        docker compose logs --tail=100 > test-artifacts/docker-logs.txt || true
        
    - name: ðŸ“¦ Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-artifacts
        path: test-artifacts/
        retention-days: 7
        
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        docker compose down -v
        docker system prune -f
